# План реструктуризации библиотеки (через MCP) и совместимость без изменений текущего кода

Дата: 2025-10-24

## Цель

- Изучить текущую библиотеку по файлу:
  - «C:\\Users\\regis\\OneDrive\\Рабочий стол\\Доделка робота 2\\SNIFFER_BIG_NEW_STAVROPOL_3-5-3_LIB.py» (далее — SNIFFER_LIB)
- Сохранить обратную совместимость: существующий код, который импортирует/использует SNIFFER_LIB, должен продолжить работать БЕЗ изменений.
- Структурировать всё содержимое библиотеки в модульную архитектуру: «ядро» + «эндпоинты» + «клиенты» + «цепочки/флоу» + «утилиты» + «модели данных» + «совместимость (shim)».
- Дополнить библиотеку всеми известными эндпоинтами и методиками из «C:\\Users\\regis\\OneDrive\\Рабочий стол\\Доделка робота 2\\Research\\tools».
- Учесть и интегрировать цепочку авторизации из «rt_lib2».

## Исходные артефакты

- Основной файл-библиотека: SNIFFER_LIB
- Папка с инструментами и наработками: «...\\Research\\tools»
- Библиотека/модуль «rt_lib2» (источник текущих шагов авторизации)

Примечание: фактический анализ кода будет выполнен MCP-агентом по промпту (см. ниже), итоги анализа будут включены в раздел «Результаты анализа» этого документа после выполнения.

## Требования к совместимости (Backwards Compatibility)

- Внешний API (имена функций/классов/точки входа), которые вызываются из SNIFFER_LIB потребителями, остаётся прежним.
- Внутри новой структуры будет добавлен слой совместимости («compat / shim»), который пробрасывает вызовы в новые модули.
- Импорт-пути, на которые опирается текущий код, должны работать (при необходимости — создать одноимённый пакет с теми же путями и экспортами символов).
- Поведение и значения по умолчанию не меняются без критической необходимости; новые параметры — только опционально.

## Целевая структура пакета

Предложенная структура (может уточняться на основе реального кода):

- rt_lib/
  - __init__.py
  - compat/                        # Слой совместимости (shim), экспортирует старые имена
    - __init__.py
    - sniffer_shim.py              # Функции/классы с прежними именами → делегируют в новые модули
  - core/                          # Ядро: конфиг, HTTP-клиент, ретраи, логирование, ошибки
    - __init__.py
    - config.py
    - http.py
    - logging.py
    - errors.py
    - retry.py
    - session.py                   # Сессионный менеджмент/куки/токены
  - auth/                          # Авторизация: из rt_lib2 + расширения
    - __init__.py
    - flows.py                     # Цепочки/стратегии авторизации
    - providers.py                 # Конкретные провайдеры/реализации
    - tokens.py                    # Работа с токенами/обновление
  - endpoints/                     # Сгруппированные эндпоинты по доменам
    - __init__.py
    - tenders.py
    - offers.py
    - profiles.py
    - attachments.py
    - notifications.py
    - ... (из Research/tools)
  - workflows/                     # Конечные сценарии и цепочки «от создания до подачи»
    - __init__.py
    - submit_offer.py
    - register_participant.py
    - search_tenders.py
    - ... (собранные цепочки из Research/tools)
  - models/                        # Pydantic/TypedDict модели входа/выхода
    - __init__.py
    - base.py
    - tender.py
    - offer.py
    - auth.py
    - profile.py
  - utils/
    - __init__.py
    - time.py
    - files.py
    - parsing.py
    - validation.py

Ключевая идея: «compat» экспортирует прежние имена и сигнатуры, внутри — вызывает соответствующую реализацию из core/auth/endpoints/workflows.

## План работ (через MCP + ручная доводка)

1) Инвентаризация существующего API
   - Собрать публичные функции/классы/константы из SNIFFER_LIB
   - Для каждого символа: сигнатура, описание, побочные эффекты, исключения, используемые глобальные параметры
   - Построить граф вызовов (кто кем пользуется) и выделить «поверхностный API» (то, что использует внешний код)

2) Сканирование Research/tools
   - Извлечь все эндпоинты (URL, методы, параметры, возвращаемые структуры)
   - Зафиксировать паттерны: авторизация, пагинация, загрузка файлов, ожидания, антибот-приёмы
   - Сопоставить найденные сценарии с целевыми workflows

3) Интеграция авторизации (rt_lib2)
   - Извлечь текущие шаги auth-цепочки
   - Нормализовать в виде «flows» (стратегии) и «providers» (конкретные реализации)
   - Описать обновление/пролонгацию токенов, ошибки, восстановление сессии

4) Проектирование ядра
   - Единый HTTP-клиент (requests/httpx) с retry, логами, таймаутами, прокси, headers
   - Менеджер сессии: сохранение куки/токенов, thread-safety, обновление
   - Единая система ошибок и классификация исключений

5) Оформление endpoints
   - Группировка по доменам, единые соглашения по именованию методов
   - Типизация входов/выходов через модели
   - Трассировка/логирование запросов и ответов (с редактированием секретов)

6) Workflows («от создания до подачи»)
   - Описать сквозные сценарии из Research/tools
   - Реализовать как композиции вызовов auth + endpoints + utils
   - Добавить «hooks»/«policies» для расширяемости

7) Слой совместимости
   - Создать sniffer_shim.py, экспортирующий прежние функции/классы
   - Таблица соответствия: OLD_NAME → NEW_PATH.new_name
   - Сохранить прежние сигнатуры и поведение; депрекейтнуть при необходимости с предупреждениями

8) Тестирование
   - Контрактные тесты совместимости: против старого SNIFFER_LIB (реестр вызовов)
   - Интеграционные тесты по основным workflows
   - «Golden» ответы для критичных эндпоинтов

9) Документация
   - README по структуре пакета
   - Таблица маппинга API (старое → новое)
   - Примеры: «как было» и «как стало» (сохраняя работоспособность старого)

## Результаты анализа (будут заполнены после запуска MCP)

- Публичные символы SNIFFER_LIB: [...]
- Критические зависимости: [...]
- Перечень эндпоинтов из Research/tools: [...]
- Auth-flow (rt_lib2): [...]

## Миграция и поэтапный план

- Этап 1: Автоматизированный отчёт MCP по SNIFFER_LIB и Research/tools, черновая таблица соответствий
- Этап 2: Создание каркаса пакета (core, auth, endpoints, workflows, models, utils, compat)
- Этап 3: Перенос функционала и покрытие тестами совместимости
- Этап 4: Добавление всех эндпоинтов и сценариев из Research/tools
- Этап 5: Полная документация и релиз 0.x с совместимостью

## Риски и меры

- Скрытые глобальные состояния → Ввести Session/Context и инкапсуляцию
- Нежёсткие контракты ответов → Ввести типизацию и валидацию
- Антибот/капчи → Выделить стратегию обхода/ручные хуки
- Изменяющиеся эндпоинты → Централизованный конфиг и версионирование

## Критерии приёмки

- Старый код против «compat» работает без изменений и проходит тесты
- Все известные эндпоинты доступны через новые модули
- Документация отражает полную картину и примеры

---

См. файл «mcp_prompt_restructure_library.txt» — готовый промпт для MCP-агента, который соберёт материалы для раздела «Результаты анализа».